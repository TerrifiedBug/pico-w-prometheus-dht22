name: Create Firmware Release

on:
  push:
    tags:
      - "v*" # Production releases (v1.0.0, v1.1.0, etc.)
      - "dev-*" # Development releases (dev-1.0.0, dev-1.1.0, etc.)

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Determine release type
        id: release_type
        run: |
          if [[ "${{ steps.version.outputs.version }}" == dev-* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "release_name=Development Release ${{ steps.version.outputs.version }}" >> $GITHUB_OUTPUT
            echo "This is a development release"
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "release_name=Release ${{ steps.version.outputs.version }}" >> $GITHUB_OUTPUT
            echo "This is a production release"
          fi

      - name: Create firmware package
        run: |
          echo "Creating firmware package..."

          # Create release directory
          mkdir -p release-package

          # Copy all firmware files
          cp firmware/* release-package/

          # Update version.txt with the tag version
          echo "${{ steps.version.outputs.version }}" > release-package/version.txt

          # List files being packaged
          echo "Files in firmware package:"
          ls -la release-package/

          # Create zip archive
          cd release-package
          zip -r ../firmware-${{ steps.version.outputs.version }}.zip .
          cd ..

          # Verify zip contents
          echo "Zip file contents:"
          unzip -l firmware-${{ steps.version.outputs.version }}.zip

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## Pico W Prometheus DHT22 Sensor Firmware

          ### ðŸ“¦ What's Included

          This firmware package contains all files needed to run the Pico W Prometheus DHT22 sensor:

          - **main.py** - Main application and HTTP server
          - **ota_updater.py** - Over-the-air update functionality
          - **config.py** - Configuration management
          - **device_config.py** - Dynamic device configuration
          - **secrets.py.example** - WiFi credentials template
          - **version.txt** - Firmware version identifier

          ### ðŸš€ Installation Instructions

          1. **Flash MicroPython** to your Pico W (if not already done)
          2. **Download** the firmware zip file below
          3. **Extract** all files to your Pico W root directory
          4. **Copy** `secrets.py.example` to `secrets.py` and add your WiFi credentials
          5. **Restart** your Pico W

          ### ðŸ”§ Configuration

          After installation, visit `http://<pico-ip>/config` to configure:
          - Device location and name
          - OTA update settings
          - GitHub repository settings

          ### ðŸ“ˆ Prometheus Integration

          Add your device to Prometheus configuration:

          ```yaml
          scrape_configs:
            - job_name: "pico_sensors"
              static_configs:
                - targets: ["<pico-ip>:80"]
          ```

          Metrics will automatically include location and device labels.

          ### ðŸ”„ OTA Updates

          This firmware supports over-the-air updates:
          - Configure via web interface at `/config`
          - Manual updates via `/update` endpoint
          - Automatic update checking (configurable)

          ### ðŸ“š Documentation

          - [Project README](https://github.com/${{ github.repository }})
          - [Configuration Guide](https://github.com/${{ github.repository }}/blob/main/docs/README.md)
          - [Troubleshooting](https://github.com/${{ github.repository }}/blob/main/docs/DYNAMIC_CONFIG_IMPLEMENTATION.md)

          EOF

          # Set output for use in release creation
          echo "notes_file=release_notes.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        run: |
          # Create release using GitHub CLI
          if [[ "${{ steps.release_type.outputs.prerelease }}" == "true" ]]; then
            gh release create ${{ steps.version.outputs.version }} \
              --title "${{ steps.release_type.outputs.release_name }}" \
              --notes-file release_notes.md \
              --prerelease
          else
            gh release create ${{ steps.version.outputs.version }} \
              --title "${{ steps.release_type.outputs.release_name }}" \
              --notes-file release_notes.md
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload firmware package and individual files
        run: |
          # Upload firmware package (new structure)
          gh release upload ${{ steps.version.outputs.version }} \
            ./firmware-${{ steps.version.outputs.version }}.zip

          # Upload individual files from firmware/ directory (new structure)
          for file in firmware/main.py firmware/version.txt; do
            if [ -f "$file" ]; then
              echo "Uploading $(basename "$file") from firmware/ directory..."
              gh release upload ${{ steps.version.outputs.version }} "$file"
            fi
          done

          # BACKWARD COMPATIBILITY: Upload root-level files for older devices
          echo "Creating backward compatibility files for older devices..."

          # Copy firmware files to root level with correct names
          cp firmware/main.py ./main.py
          cp firmware/config.py ./config.py
          cp firmware/ota_updater.py ./ota_updater.py
          cp firmware/device_config.py ./device_config.py
          cp firmware/secrets.py.example ./secrets.py.example

          # Upload root-level files for backward compatibility (will overwrite the firmware/ versions)
          echo "Uploading backward compatibility files at root level..."
          gh release upload ${{ steps.version.outputs.version }} ./main.py --clobber
          gh release upload ${{ steps.version.outputs.version }} ./config.py --clobber
          gh release upload ${{ steps.version.outputs.version }} ./ota_updater.py --clobber
          gh release upload ${{ steps.version.outputs.version }} ./device_config.py --clobber
          gh release upload ${{ steps.version.outputs.version }} ./secrets.py.example --clobber

          echo "âœ… Uploaded root-level files for backward compatibility with older devices"

          # Clean up temporary files
          rm -f ./main.py ./config.py ./ota_updater.py ./device_config.py ./secrets.py.example
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "## ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ steps.release_type.outputs.prerelease == 'true' && 'Development' || 'Production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Assets Created:" >> $GITHUB_STEP_SUMMARY
          echo "- firmware-${{ steps.version.outputs.version }}.zip (Complete firmware package)" >> $GITHUB_STEP_SUMMARY
          echo "- main.py, config.py, ota_updater.py, device_config.py, secrets.py.example (Root-level files for backward compatibility)" >> $GITHUB_STEP_SUMMARY
          echo "- version.txt (Version identifier)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Backward Compatibility:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Old devices can update using root-level files" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… New deployments use firmware/ directory structure" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No breaking changes for existing installations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Test the release on development devices" >> $GITHUB_STEP_SUMMARY
          echo "2. Update any devices using OTA updates" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor device health after deployment" >> $GITHUB_STEP_SUMMARY
